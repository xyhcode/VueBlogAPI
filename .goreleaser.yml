# .goreleaser.yml - Anheyu App Release Configuration

# GoReleaser é…ç½®ç‰ˆæœ¬
version: 2

# é¡¹ç›®é…ç½®
project_name: anheyu-app

# Git é…ç½®
git:
  # ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ’åº
  tag_sort: -version:refname
  # æŒ‡å®šé¢„å‘å¸ƒç‰ˆæœ¬çš„åç¼€ï¼Œå¸®åŠ© GoReleaser è¯†åˆ«é¢„å‘å¸ƒç‰ˆæœ¬
  # å‘å¸ƒæ­£å¼ç‰ˆæ—¶ï¼Œä½¿ç”¨ GORELEASER_PREVIOUS_TAG ç¯å¢ƒå˜é‡æŒ‡å®šä¸Šä¸€ä¸ªæ­£å¼ç‰ˆæœ¬
  # ä¾‹å¦‚: GORELEASER_PREVIOUS_TAG=v1.6.8 goreleaser release --clean
  prerelease_suffix: "-"

# ç¯å¢ƒå˜é‡
env:
  - GO111MODULE=on
  - CGO_ENABLED=0

# æ„å»ºå‰é’©å­ - æ„å»ºå‰ç«¯èµ„æº
before:
  hooks:
    - go mod tidy
    - go mod download

# æ„å»ºé…ç½®
builds:
  - id: anheyu-app
    main: ./main.go
    binary: anheyu-app

    # ç‰ˆæœ¬ä¿¡æ¯æ³¨å…¥
    ldflags:
      - -s -w
      - -X 'github.com/anzhiyu-c/anheyu-app/internal/pkg/version.Version={{.Version}}'
      - -X 'github.com/anzhiyu-c/anheyu-app/internal/pkg/version.Commit={{.ShortCommit}}'
      - -X 'github.com/anzhiyu-c/anheyu-app/internal/pkg/version.Date={{.Date}}'

    # æ„å»ºç›®æ ‡
    goos:
      - linux
      - windows
      - darwin

    goarch:
      - amd64
      - arm64

    # ç‰¹å®šå¹³å°é…ç½®
    goamd64:
      - v1

    # å¿½ç•¥ç‰¹å®šç»„åˆ
    ignore:
      - goos: windows
        goarch: arm64

    # è¾“å‡ºæ–‡ä»¶åæ¨¡æ¿
    hooks:
      post:
        - cmd: echo "Built {{ .Path }}"

# å½’æ¡£é…ç½®
archives:
  - id: anheyu-app-archives
    # GoReleaser v2 è‡ªåŠ¨å…³è”æ‰€æœ‰æ„å»ºï¼Œæ— éœ€æŒ‡å®š builds

    # å½’æ¡£æ–‡ä»¶åæ¨¡æ¿
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}"

    # æ–‡ä»¶æ ¼å¼ (v2 æœ€æ–°è¯­æ³•)
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip

    # åŒ…å«çš„æ–‡ä»¶ (ç°åœ¨å¯ä»¥ä½¿ç”¨ç®€å•globï¼Œå› ä¸ºæœ‰.gitkeepæ–‡ä»¶)
    files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/**/*

# Checksum é…ç½®
checksum:
  name_template: "{{ .ProjectName }}_{{ .Version }}_checksums.txt"
  algorithm: sha256

# å¿«ç…§é…ç½®
snapshot:
  # GoReleaser v2 ä½¿ç”¨ version_template æ›¿ä»£ name_template
  version_template: "{{ .Version }}-SNAPSHOT-{{ .ShortCommit }}"

# æ›´æ–°æ—¥å¿—é…ç½®
changelog:
  sort: asc
  use: github

  # æ§åˆ¶ commit hash çš„æ˜¾ç¤ºé•¿åº¦
  abbrev: 7

  filters:
    exclude:
      - "Merge pull request"
      - "Merge branch"

  groups:
    - title: "ğŸš€ æ–°åŠŸèƒ½"
      regexp: "^feat(\\([\\w-]+\\))?: .*$"
      order: 0
    - title: "ğŸ› é—®é¢˜ä¿®å¤"
      regexp: "^fix(\\([\\w-]+\\))?: .*$"
      order: 1
    - title: "ğŸ“š æ–‡æ¡£æ›´æ–°"
      regexp: "^docs(\\([\\w-]+\\))?: .*$"
      order: 2
    - title: "âš¡ï¸ æ€§èƒ½ä¼˜åŒ–"
      regexp: "^perf(\\([\\w-]+\\))?: .*$"
      order: 3
    - title: "â™»ï¸ ä»£ç é‡æ„"
      regexp: "^refactor(\\([\\w-]+\\))?: .*$"
      order: 4
    - title: "ğŸ’„ ä»£ç æ ¼å¼"
      regexp: "^style(\\([\\w-]+\\))?: .*$"
      order: 5
    - title: "âœ… æµ‹è¯•ç›¸å…³"
      regexp: "^test(\\([\\w-]+\\))?: .*$"
      order: 6
    - title: "ğŸ‘· CIé…ç½®"
      regexp: "^ci(\\([\\w-]+\\))?: .*$"
      order: 7
    - title: "ğŸ“¦ï¸ æ„å»ºç³»ç»Ÿ"
      regexp: "^build(\\([\\w-]+\\))?: .*$"
      order: 8
    - title: "ğŸ”§ å…¶ä»–æ›´æ–°"
      regexp: "^chore(\\([\\w-]+\\))?: .*$"
      order: 999

# Docker é•œåƒé…ç½® - å¤šæ¶æ„æ”¯æŒ (AMD64 + ARM64)
dockers:
  # AMD64 é•œåƒ - ç‰ˆæœ¬æ ‡ç­¾
  - id: anheyu-app-docker-amd64-versioned
    goos: linux
    goarch: amd64

    image_templates:
      - "anheyu/anheyu-backend:{{ .Version }}-amd64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/amd64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"
      - "--label=org.opencontainers.image.source={{ .GitURL }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"
      - "--label=org.opencontainers.image.created={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # AMD64 é•œåƒ - latest æ ‡ç­¾ï¼ˆä»…æ­£å¼ç‰ˆæœ¬ï¼‰
  - id: anheyu-app-docker-amd64-latest
    goos: linux
    goarch: amd64
    skip_push: '{{ or (contains .Version "beta") (contains .Version "alpha") (contains .Version "rc") }}'

    image_templates:
      - "anheyu/anheyu-backend:latest-amd64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/amd64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"
      - "--label=org.opencontainers.image.source={{ .GitURL }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"
      - "--label=org.opencontainers.image.created={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # ARM64 é•œåƒ - ç‰ˆæœ¬æ ‡ç­¾
  - id: anheyu-app-docker-arm64-versioned
    goos: linux
    goarch: arm64

    image_templates:
      - "anheyu/anheyu-backend:{{ .Version }}-arm64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/arm64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"
      - "--label=org.opencontainers.image.source={{ .GitURL }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"
      - "--label=org.opencontainers.image.created={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # ARM64 é•œåƒ - latest æ ‡ç­¾ï¼ˆä»…æ­£å¼ç‰ˆæœ¬ï¼‰
  - id: anheyu-app-docker-arm64-latest
    goos: linux
    goarch: arm64
    skip_push: '{{ or (contains .Version "beta") (contains .Version "alpha") (contains .Version "rc") }}'

    image_templates:
      - "anheyu/anheyu-backend:latest-arm64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/arm64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"
      - "--label=org.opencontainers.image.source={{ .GitURL }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"
      - "--label=org.opencontainers.image.created={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # AMD64 é•œåƒ - Betaæ ‡ç­¾ï¼ˆä»…åœ¨betaç‰ˆæœ¬æ—¶æ„å»ºï¼‰
  - id: anheyu-app-docker-amd64-beta
    goos: linux
    goarch: amd64
    skip_push: '{{ not (contains .Version "beta") }}'

    image_templates:
      - "anheyu/anheyu-backend:beta-amd64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/amd64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # ARM64 é•œåƒ - Betaæ ‡ç­¾ï¼ˆä»…åœ¨betaç‰ˆæœ¬æ—¶æ„å»ºï¼‰
  - id: anheyu-app-docker-arm64-beta
    goos: linux
    goarch: arm64
    skip_push: '{{ not (contains .Version "beta") }}'

    image_templates:
      - "anheyu/anheyu-backend:beta-arm64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/arm64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # AMD64 é•œåƒ - Alphaæ ‡ç­¾ï¼ˆä»…åœ¨alphaç‰ˆæœ¬æ—¶æ„å»ºï¼‰
  - id: anheyu-app-docker-amd64-alpha
    goos: linux
    goarch: amd64
    skip_push: '{{ not (contains .Version "alpha") }}'

    image_templates:
      - "anheyu/anheyu-backend:alpha-amd64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/amd64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # ARM64 é•œåƒ - Alphaæ ‡ç­¾ï¼ˆä»…åœ¨alphaç‰ˆæœ¬æ—¶æ„å»ºï¼‰
  - id: anheyu-app-docker-arm64-alpha
    goos: linux
    goarch: arm64
    skip_push: '{{ not (contains .Version "alpha") }}'

    image_templates:
      - "anheyu/anheyu-backend:alpha-arm64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/arm64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # AMD64 é•œåƒ - RCæ ‡ç­¾ï¼ˆä»…åœ¨rcç‰ˆæœ¬æ—¶æ„å»ºï¼‰
  - id: anheyu-app-docker-amd64-rc
    goos: linux
    goarch: amd64
    skip_push: '{{ not (contains .Version "rc") }}'

    image_templates:
      - "anheyu/anheyu-backend:rc-amd64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/amd64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

  # ARM64 é•œåƒ - RCæ ‡ç­¾ï¼ˆä»…åœ¨rcç‰ˆæœ¬æ—¶æ„å»ºï¼‰
  - id: anheyu-app-docker-arm64-rc
    goos: linux
    goarch: arm64
    skip_push: '{{ not (contains .Version "rc") }}'

    image_templates:
      - "anheyu/anheyu-backend:rc-arm64"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/arm64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

# Docker Manifest é…ç½® - å¤šæ¶æ„é•œåƒèšåˆ
docker_manifests:
  # ç‰ˆæœ¬æ ‡ç­¾çš„å¤šæ¶æ„ manifestï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰
  - name_template: "anheyu/anheyu-backend:{{ .Version }}"
    image_templates:
      - "anheyu/anheyu-backend:{{ .Version }}-amd64"
      - "anheyu/anheyu-backend:{{ .Version }}-arm64"

  # latest æ ‡ç­¾çš„å¤šæ¶æ„ manifestï¼ˆä»…æ­£å¼ç‰ˆæœ¬ï¼‰
  - name_template: "anheyu/anheyu-backend:latest"
    image_templates:
      - "anheyu/anheyu-backend:latest-amd64"
      - "anheyu/anheyu-backend:latest-arm64"
    skip_push: '{{ or (contains .Version "beta") (contains .Version "alpha") (contains .Version "rc") }}'

  # Betaç‰ˆæœ¬çš„å¤šæ¶æ„ manifest
  - name_template: "anheyu/anheyu-backend:beta"
    skip_push: '{{ not (contains .Version "beta") }}'
    image_templates:
      - "anheyu/anheyu-backend:beta-amd64"
      - "anheyu/anheyu-backend:beta-arm64"

  # Alphaç‰ˆæœ¬çš„å¤šæ¶æ„ manifest
  - name_template: "anheyu/anheyu-backend:alpha"
    skip_push: '{{ not (contains .Version "alpha") }}'
    image_templates:
      - "anheyu/anheyu-backend:alpha-amd64"
      - "anheyu/anheyu-backend:alpha-arm64"

  # RCç‰ˆæœ¬çš„å¤šæ¶æ„ manifest
  - name_template: "anheyu/anheyu-backend:rc"
    skip_push: '{{ not (contains .Version "rc") }}'
    image_templates:
      - "anheyu/anheyu-backend:rc-amd64"
      - "anheyu/anheyu-backend:rc-arm64"

# GitHub Release é…ç½®
release:
  github:
    owner: anzhiyu-c
    name: anheyu-app

  # Release åç§°
  name_template: "Anheyu App {{ .Tag }}"

  # å‘å¸ƒæ¨¡å¼
  mode: replace

  # é¢„å‘å¸ƒæ£€æµ‹
  prerelease: auto

  # Release Notes æ¨¡æ¿
  header: |
    ## Anheyu App {{ .Tag }}

    {{- if .Prerelease }}

    ğŸ§ª **é¢„å‘å¸ƒç‰ˆæœ¬ï¼**

    > âš ï¸ è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç¨³å®šçš„åŠŸèƒ½æˆ–å·²çŸ¥é—®é¢˜ã€‚ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

    {{- else }}

    ğŸ‰ **æ­£å¼ç‰ˆæœ¬å‘å¸ƒï¼**

    {{- end }}

    ### ğŸ“‹ æ„å»ºä¿¡æ¯
    - **ç‰ˆæœ¬**: `{{ .Tag }}`{{ if .Prerelease }} (é¢„å‘å¸ƒ){{ end }}
    - **Commit**: [`{{ .ShortCommit }}`](https://github.com/anzhiyu-c/anheyu-app/commit/{{ .FullCommit }})
    - **æ„å»ºæ—¶é—´**: `{{ .Date }}`
    - **Go ç‰ˆæœ¬**: `{{ .Env.GOVERSION }}`

    {{- if .Prerelease }}

    ### ğŸ” é¢„å‘å¸ƒè¯´æ˜
    {{- if contains .Tag "beta" }}
    - æ­¤ç‰ˆæœ¬åŒ…å«æ–°åŠŸèƒ½çš„æµ‹è¯•å®ç°ï¼Œå¯èƒ½å­˜åœ¨åŠŸèƒ½ä¸å®Œæ•´æˆ–ç¨³å®šæ€§é—®é¢˜
    - æ¬¢è¿æµ‹è¯•å¹¶åé¦ˆé—®é¢˜ï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›
    {{- else if contains .Tag "alpha" }}
    - æ­¤ç‰ˆæœ¬åŒ…å«æ—©æœŸå¼€å‘çš„åŠŸèƒ½ï¼Œéå¸¸ä¸ç¨³å®šï¼Œä»…ä¾›å¼€å‘æµ‹è¯•ä½¿ç”¨
    - ä¸å»ºè®®åœ¨ä»»ä½•é‡è¦ç¯å¢ƒä¸­ä½¿ç”¨
    {{- else if contains .Tag "rc" }}
    - æ­¤ç‰ˆæœ¬æ˜¯æ­£å¼ç‰ˆçš„å€™é€‰ç‰ˆæœ¬ï¼ŒåŠŸèƒ½ç›¸å¯¹ç¨³å®šä½†éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•
    - å¦‚æ— é‡å¤§é—®é¢˜ï¼Œå°†æˆä¸ºä¸‹ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬
    {{- end }}

    {{- end }}

  footer: |
    ---

    ### ğŸ“š ç›¸å…³é“¾æ¥
    - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/anzhiyu-c/anheyu-app/releases)
    - [æ–‡æ¡£](https://dev.anheyu.com/)
    - [é—®é¢˜åé¦ˆ](https://github.com/anzhiyu-c/anheyu-app/issues)

    **å®Œæ•´çš„ SHA256 æ ¡éªŒå’Œ**ï¼š[anheyu-app_{{ .Tag }}_checksums.txt](https://github.com/anzhiyu-c/anheyu-app/releases/download/{{ .Tag }}/anheyu-app_{{ .Tag }}_checksums.txt)

# å…¬å‘Šé…ç½®
announce:
  skip: "{{gt .Patch 0}}" # è·³è¿‡ patch ç‰ˆæœ¬çš„å…¬å‘Š
